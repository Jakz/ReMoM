;
; +-------------------------------------------------------------------------+
; |   This file	has been generated by The Interactive Disassembler (IDA)    |
; |	   Copyright (c) 2009 by Hex-Rays, <support@hex-rays.com>	    |
; |			 License info: AC-7625-2E2D-92			    |
; |				 Valued	Client				    |
; +-------------------------------------------------------------------------+
;
; Input	MD5   :	AABF5C934234A70885DEA7A0C8B3B5DE


    Ideal
    ;include uni.inc ; see unicode subdir of ida	for info on unicode

    p386n
    model large

    ;include "__MAGIC.inc"

EXTRN _fclose:FAR
EXTRN _fopen:FAR
EXTRN _fread:FAR
EXTRN _printf:FAR

EXTRN _f040101_DosFindFile:FAR
EXTRN _f050207_EXIT_CleanUp:FAR
EXTRN _f060206_DOS_PrintAndExit:FAR


struc BCpp30_DOSH_dosSearchInfo	; (sizeof=0x2B)
    ds_drive db ?
    ds_pattern db 13 dup(?)
    ds_reserved db 7 dup(?)
    ds_attrib db ?
    ds_time	dw ?
    ds_date	dw ?
    ds_size	dd ?
    ds_nameZ db 13 dup(?)
ends BCpp30_DOSH_dosSearchInfo


; Segment type:	Pure code
segment	seg004 byte public 'CODE' use16
    assume cs:seg004
    ;org 0Ch
    ;assume es:nothing, ss:nothing, ds:dseg, fs:nothing,	gs:nothing

PUBLIC _f040101_DosFindFile

; Attributes: bp-based frame

proc _f040101_DosFindFile far

varDosDtaPspAsciizFileNameAddr=	word ptr -4
varDTA_ES= word	ptr -2

argCharPtrFileName= dword ptr  6
argCharPtrDestinationBuffer= dword ptr	0Ah

    push bp
    mov	bp, sp
    sub	sp, 4
    push es
    push di
    push ds
    push si
    push ds
    
    ;call Disable_Set_FLAG_Mouse_Skip
    
    mov	ah, 2Fh
    int	21h
    ;add	bx, BCpp30_DOSH_dosSearchInfo.ds_nameZ
    ;add	bx, [BCpp30_DOSH_dosSearchInfo.ds_nameZ]
    add	bx, 1Eh
    mov	[bp+varDosDtaPspAsciizFileNameAddr], bx
    mov	bx, es
    mov	[bp+varDTA_ES],	bx
    mov	si, [word ptr bp+argCharPtrFileName]
    lodsb
    cmp	al, 0
    jz	short FIND_NEXT

FIND_FIRST:
    push ds
    mov	ah, 4Eh
    mov	cx, 0
    mov	dx, [word ptr bp+argCharPtrFileName]
    int	21h
    pop	ds
    jb	short FILE_NOT_FOUND

j_FILE_FOUND:
    jmp	short FILE_FOUND
    ;align 2

FIND_NEXT:
    mov	ah, 4Fh
    int	21h
    jb	short FILE_NOT_FOUND

FILE_FOUND:
    mov	ax, ds
    mov	es, ax
    ;assume es:dseg
    mov	di, [word ptr bp+argCharPtrFileName+2]
    mov	si, [bp+varDosDtaPspAsciizFileNameAddr]
    mov	ax, [bp+varDTA_ES]
    mov	ds, ax

ASCIIZ_COPY_SI_TO_DI:
    lodsb
    stosb
    cmp	al, 0
    jnz	short ASCIIZ_COPY_SI_TO_DI

RET_FILE_FOUND:
    mov	ax, -1
    pop	ds
    push ax
    ;call Restore_Set_FLAG_Mouse_Skip
    pop	ax
    pop	si
    pop	ds
    pop	di
    pop	es
    ;assume es:nothing
    mov	sp, bp
    pop	bp
    retf

FILE_NOT_FOUND:
    mov	al, 0
    mov	si, [word ptr bp+argCharPtrFileName+2]
    mov	[si], al
    mov	ax, 0
    pop	ds
    push ax
    ;call Restore_Set_FLAG_Mouse_Skip
    pop	ax
    pop	si
    pop	ds
    pop	di
    pop	es
    mov	sp, bp
    pop	bp
    retf
    
endp _f040101_DosFindFile

;byte_1420C db 6, 57h, 1Eh, 56h,	0BAh, 2	dup(0)
;    db 0B4h, 36h, 0CDh,	21h, 3Dh, 2 dup(0FFh)
;    db 74h, 7, 0F7h, 0E1h, 0F7h, 0E3h, 0EBh
;    db 7, 90h, 0BAh, 2 dup(0FFh), 0B8h,	2 dup(0FFh)
;    db 5Eh, 1Fh, 5Fh, 7, 0CBh

ends seg004

end
